#### Module 2: Threading and Queues

###### Threading and Queues- Create task queues- Threads receive tasks- Threads complete tasks and inform the queue
- All threads exit once queue is empty

Queue &rightarrow; Thread

```sh
➜  Lesson-15 git:(master) ✗ cat queue.py
#!/usr/bin/python

import threading
import Queue
import time

class WorkerThread(threading.Thread) : # Subclass of threading.Thread (Workerclass which fetches tasks from this queue and executes them)

	def __init__(self, queue) : # Constructor takes the input queue
		threading.Thread.__init__(self)
		self.queue = queue

	def run(self) : # This function can be anything
		print "In WorkerThread"
		while True :
			counter = self.queue.get()
			print "Ordered to sleep for %d seconds!"%counter
			time.sleep(counter)
			print "Finsihed sleeping for %d seconds"%counter
			self.queue.task_done()

queue = Queue.Queue() # Creating a new queue

for i in range(10) : # Creating a bunch of worker threads
	print "Creating WorkerThread : %d"%i
	worker = WorkerThread(queue)
	worker.setDaemon(True)
	worker.start()
	print "WorkerThread %d Created!"%i

for j in range (10): # Putting the worker threads in the queue
	queue.put(j)

queue.join() # Waits for the task queue to be empty

print "All tasks over!"
➜  Lesson-15 git:(master) ✗
```

```sh
➜  Lesson-15 git:(master) ✗ ./queue.py
Creating WorkerThread : 0
In WorkerThread
WorkerThread 0 Created!
Creating WorkerThread : 1
In WorkerThread
WorkerThread 1 Created!
Creating WorkerThread : 2
In WorkerThread
 WorkerThread 2 Created!
Creating WorkerThread : 3
WorkerThread 3 Created!
Creating WorkerThread : 4In WorkerThread

In WorkerThread
WorkerThread 4 Created!
Creating WorkerThread : 5
In WorkerThread
WorkerThread 5 Created!
Creating WorkerThread : 6
In WorkerThread
WorkerThread 6 Created!
Creating WorkerThread : 7
In WorkerThread
WorkerThread 7 Created!
Creating WorkerThread : 8
In WorkerThread
WorkerThread 8 Created!
Creating WorkerThread : 9
In WorkerThread
WorkerThread 9 Created!
Ordered to sleep for 0 seconds!
Finsihed sleeping for 0 seconds
Ordered to sleep for 1 seconds!
 Ordered to sleep for 2 seconds!
Ordered to sleep for 3 seconds!
Ordered to sleep for 4 seconds!
Ordered to sleep for 5 seconds!
Ordered to sleep for 6 seconds!
 Ordered to sleep for 7 seconds!
Ordered to sleep for 8 seconds!Ordered to sleep for 9 seconds!

Finsihed sleeping for 1 seconds
Finsihed sleeping for 2 seconds
Finsihed sleeping for 3 seconds
Finsihed sleeping for 4 seconds
Finsihed sleeping for 5 seconds
Finsihed sleeping for 6 seconds
Finsihed sleeping for 7 seconds
Finsihed sleeping for 8 seconds
Finsihed sleeping for 9 seconds
All tasks over!
➜  Lesson-15 git:(master) ✗
```

###### Exercise

- Create a list of FTP sites- Create a WorkerThread and Queue which can login to these sites and list the root directory and exit- Use 5 threads for this job and 10 FTP sites

```sh
➜  Lesson-15 git:(master) ✗ cat ftp_list.py
import Queue
import threading
from ftplib import FTP

ftpList = ['ftp.aao.gov.au',
           'ftp.al.com.au',
	   	   'ftp.jcu.edu.au',
		   'ftp.marine.csiro.au',
		   'ftp.cs.brown.edu',
		   'ftp.3k.com',
		   'ftp.aero.jussieu.fr',
		   'ftp.linux.hr',
		   'ftp.invircible.co.il',
		   'ftp.avm.de']

class WorkingThread(threading.Thread):

	def __init__(self, queue):
		threading.Thread.__init__(self)
		self.queue = queue

	def run(self):
		while not self.queue.empty() :
			ftp = self.queue.get()
			ftp_access(ftp)
			self.queue.task_done()

def ftp_access(ftp) :
	try :
		url = FTP(ftp)
		url.login()
	except :
		print 'Unable to log into %s' %ftp
	else :
		print "-"*10,ftp,"-"*10
		print url.retrlines('LIST')
		print"\n"
		url.quit()

queue = Queue.Queue()

for ftp in ftpList:
	queue.put(ftp)

for i in ftpList:
	worker = WorkingThread(queue)
	worker.setDaemon(True)
	worker.start()

queue.join()
➜  Lesson-15 git:(master) ✗
```

```sh
➜  Lesson-15 git:(master) ✗ python ftp_list.py
Unable to log into ftp.al.com.auUnable to log into ftp.3k.com

---------- ftp.cs.brown.edu ----------
drwxrwxrwt    2 0          0              131072 Aug 20 02:30 incoming
drwxr-xr-x   33 0          2                8192 Aug 13  2013 pub
drwxr-xr-x   52 0          2                8192 Feb 10  2016 u
226-Options: -l
226 3 matches total


---------- ftp.aero.jussieu.fr ----------
---------- ftp.avm.de ----------
---------- ftp.linux.hr ----------
drwxr-x---   2 ftpadm   ftpgroup     4096 Sep 20  2011 accent
drwxr-x---   2 ftpadm   ftpgroup        6 Jul  1 08:34 access-ftp
lrwxr-x---   1 ftpadm   ftpgroup        8 Sep 20  2011 aeronomie -> outgoing
drwxr-x---   3 ftpadm   ftpgroup       82 May 31  2012 climslip_pub
drwxr-x---   2 ftpadm   ftpgroup     4096 Apr 16  2014 dell
lrwxr-x---   1 ftpadm   ftpgroup        8 Sep 20  2011 latmos -> outgoing
drwxr-x---  96 ftpadm   ftpgroup     4096 Jun 20 12:19 outgoing
drwxr-x---   4 ftpadm   ftpgroup       69 Dec 19  2008 polarcat_pub
drwxr-x---   6 ftpadm   ftpgroup     4096 Jul  6  2016 pub
-rwxr-x---   1 ftpadm   ftpgroup       26 May 30  2011 robots.txt
drwxr-x---  20 ftpadm   ftpgroup     4096 Jul  4 12:47 saoz-ftp
drwxr-x---   2 ftpadm   ftpgroup     4096 May 29  2012 traqa-ftp
-rwxr-x---   1 ftpadm   ftpgroup      259 Aug 20 22:51 welcome.msg
---------- ftp.aao.gov.au ----------
drwxr-xr-x   48 ftp      ftp          4096 Jul 31 16:19 cardware
drwxr-xr-x   14 ftp      ftp          4096 Oct 17  2013 develper
drwxr-xr-x   98 ftp      ftp          4096 May 18 10:06 fritz.box
-rw-r--r--    1 ftp      ftp         74610 Jun 06  2012 hist-deu.txt
-rw-r--r--    1 ftp      ftp         28537 Oct 22  2010 hist-eng.txt
-rw-r--r--    1 ftp      ftp          1468 Jul 27  2010 info-deu.txt
-rw-r--r--    1 ftp      ftp          1672 Jul 27  2010 info-eng.txt
drwxr-xr-x    6 ftp      ftp          4096 Apr 03  2013 networks
drwxr-xr-x   11 ftp      ftp          4096 Apr 03  2013 programs
drwxr-xr-x    2 ftp      ftp          4096 Jun 06  2016 public
drwxr-xr-x   13 ftp      ftp          4096 Apr 03  2013 tools
226 Transfer complete


-rw-rw-r--    1 1000     3000         2392 Mar 01  2013 README
-rw-r--r--    1 1000     1000          823 Mar 28  2008 README.badreferrer.html
drwxr-xr-x    3 1001     0              17 Jun 30  2010 android
drwxr-xr-x    4 1001     0              33 Jan 06  2009 asuseee
drwxr-xr-x   10 1001     3000         4096 Jun 09  2007 centos
drwxrwsr-x    4 30574    8000           67 Sep 04  1999 dokumentacija
drwxrwsr-x    2 1000     3000           52 Nov 22  2002 droper
drwxr-xr-x   33 1007     3000         4096 Nov 21  2008 emisija
drwxrwsr-x    7 1001     3000         4096 Jun 13  2003 fakebo
drwxrwsr-x    2 0        3000          150 Sep 04  1999 fonts
drwxr-xr-x   31 1000     1000         4096 Aug 09 15:30 gcrypt
drwxr-sr-x    2 30538    3000           84 Feb 23  2010 gls
drwxrwxr-x    3 1001     3000         4096 Jun 08  2007 hrid
drwxr-xr-x   22 1000     1000         4096 Dec 06  2011 isc
drwxr-xr-x    2 1001     0            4096 Jan 04  2012 kindle
drwxr-xr-x    9 1001     3000         8192 Sep 17  2013 knoppix
drwxr-xr-x    3 1001     3000         4096 Oct 26  2016 knoppix-dvd
drwxr-xr-x    2 1000     1000            6 Oct 23  2009 lesstif
drwxrwsr-x    7 1001     100            79 Aug 20  2010 lokalizacija
drwxr-xr-x    5 1008     3000           53 Jan 08  2010 media
drwxrwsr-x    3 30542    3000          130 Sep 04  1999 microlinux
drwxrwsr-x    2 1000     3000         4096 Dec 29  1999 oem
drwxr-xr-x    6 1000     1000           78 Sep 25  2011 openoffice
drwxr-xr-x    5 1000     1000         8192 Apr 22  2012 openssh
drwxr-xr-x    4 1000     1000           34 Nov 19  2014 openssl
drwxr-xr-x    5 1001     3000           41 Mar 20  2010 openvas
drwxr-xr-x   19 1000     1000         4096 Aug 03 14:20 php
drwxr-xr-x    2 1001     3000         4096 Jan 09  2008 podcast
drwxr-xr-x    5 1000     1000         4096 Aug 22  2016 postfix
lrwxrwxrwx    1 0        0               1 Jun 06  2007 pub -> .
drwxrwxr-x   24 1001     3000         4096 Jan 05  2011 puppylinux
-rw-r--r--    1 0        3000            0 Feb 17  2007 robots.txt
drwxrwsr-x    4 1001     3000         4096 Dec 30  2001 si3d
drwxr-xr-x    6 1006     100           129 Apr 23  2004 spell
drwxr-xr-x    5 30580    3000           70 Sep 26  2012 swapd
drwxrwsr-x    2 1001     3000         4096 Dec 05  2000 xplsisnjasp
226 Directory send OK.


---------- ftp.jcu.edu.au ----------
---------- ftp.marine.csiro.au ----------
drwx------    2 0        0           16384 Nov 23  2006 lost+found
dr-xr-xr-x   19 0        0            4096 Oct 11  2015 pub
226 Directory send OK.


226 Directory send OK.


drwxr-xr-x   7 ftpadm   ftpadm        232 Mar 30 01:25 .
drwxr-xr-x   7 ftpadm   ftpadm        232 Mar 30 01:25 ..
d-wxrwsrwx  27 ftpadm   ftpadm        672 May 25 01:50 incoming
drwxr-xr-x   3 ftpadm   ftpadm         88 Mar 12  2005 mirror
drwxrwxrwx 167 ftpadm   ftpadm       5424 Jun 13 05:27 pub
-rw-r--r--   1 ftpadm   ftpadm         26 Mar 30 01:26 robots.txt
drwxr-xr-x  15 ftpadm   ftpadm        376 Oct 29  2007 software
-rw-r--r--   1 ftpadm   ftpadm         47 May 26  2010 welcome.msg
226 Transfer complete.


dr-xr-xr-x   2 ftp      ftp          4096 Mar 16  2015 bin
dr-xr-xr-x   2 ftp      ftp          4096 Oct  2  1999 Boot
dr-xr-xr-x  10 ftp      ftp          4096 Oct  2  1999 doc
drwxr-sr-x  12 ftp      ftp          4096 Jul 18  2016 pub
-rw-r--r--   1 ftp      ftp          2376 May 14  2010 README
drwxrwx-wt   2 ftp      ftp         36864 Jun 22 13:50 upload
-rw-r--r--   1 ftp      ftp          1802 Jun 14  2001 welcome.msg
226 Transfer complete


Unable to log into ftp.invircible.co.il
Done
➜  Lesson-15 git:(master) ✗
```